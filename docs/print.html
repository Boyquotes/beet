<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Beet</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="deps/custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Beet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial/getting-started.html"><strong aria-hidden="true">1.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="tutorial/concepts-theory.html"><strong aria-hidden="true">1.2.</strong> Concepts - Theory</a></li><li class="chapter-item expanded "><a href="tutorial/concepts-example.html"><strong aria-hidden="true">1.3.</strong> Concepts - Example</a></li></ol></li><li class="chapter-item expanded "><a href="ecs/index.html"><strong aria-hidden="true">2.</strong> ECS</a></li><li class="chapter-item expanded "><a href="beetmash/index.html"><strong aria-hidden="true">3.</strong> Beetmash</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="misc/roadmap.html">Roadmap</a></li><li class="chapter-item expanded affix "><a href="misc/resources.html">Resources</a></li><li class="chapter-item expanded affix "><a href="misc/contributing.html">Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Beet</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="beet"><a class="header" href="#beet">Beet</a></h1>
<p>Beet is a task switching library suitable for game AI, robotics &amp; other performance-critical environments.</p>
<iframe src="https://mrchantey.github.io/beet/play/?spawn-bee=&spawn-flower=&hide-graph=&graph=CAAAAAAAAABOZXcgTm9kZQEAAAAAAAAAAAAAAAAAAD%2FNzMw9AAAAAAAAAAA"></iframe>
<p><em>Examples are built with the <a href="https://mrchantey.github.io/beet/play?spawn-bee=1">beet playground</a>, feel free to experiment with the bee's graph then spawn some to see the effect.</em></p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<h3 id="-modular"><a class="header" href="#-modular">üå≥ Modular</a></h3>
<p>Beet follows the ECS architecture, each node (entity) is simply a list of actions (components). Action Graphs can be composed of other graphs, allowing for epic code reusability.</p>
<h3 id="-multi-paradigm"><a class="header" href="#-multi-paradigm">üåà Multi-paradigm</a></h3>
<p>Mix-and-match techniques from different Behavior Selection approaches for each point in the graph. Currently only Behavior Tree and Utility AI techniques are supported, but the architecture is highly extendable, allowing for state-machine transitions, GOAP, etc.</p>
<h3 id="-flexible"><a class="header" href="#-flexible">üåç Flexible</a></h3>
<p>Beet is built upon the lightweight <code>bevy_ecs</code> crate, which can target epic gaming rigs and tiny microcontrollers alike. Of course if you're using Bevy as your app framework there will be no need for blackboards etc but this is by no means a requirement. </p>
<blockquote>
<p>If you would prefer to read code the <a href="https://github.com/mrchantey/beet/blob/main/crates/beet_web/src/bee/bee_game.rs">Beet Playground</a> is a great example of a non-ecs application that uses the <code>beet_net</code> pubsub framework to sync with the AI.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>By the end of this chapter you'll have a strong understanding of how to build the following demo:</p>
<iframe src="https://mrchantey.github.io/beet/play/?spawn-bee=1"></iframe>
<div style="break-before: page; page-break-before: always;"></div><h1 id="concepts"><a class="header" href="#concepts">Concepts</a></h1>
<!-- keep all code references in sync with docs please -->
<p>The terminology from this library is a wip and will likely change.</p>
<h2 id="actions"><a class="header" href="#actions"><code>Actions</code></a></h2>
<p><em>aka <code>tasks</code></em></p>
<p>Actions are something to be performed for a given node, in beet this a combination of a <code>Component</code>, the data required for the task, and a <code>System</code>, the accompanying logic for that task. They usually either get an agent to do something or send information to their parent.</p>
<p>Here are some examples of actions:</p>
<ul>
<li><code>SucceedInDuration</code>
<ul>
<li>After a given <code>Duration</code>, set <code>RunResult</code> to <code>RunResult::Successs</code></li>
</ul>
</li>
<li><code>Hover</code>
<ul>
<li>The entity will slowly move up and down in a sinusoidal pattern.</li>
</ul>
</li>
</ul>
<p>Notice the primitive nature of these actions, they could be combined to create a &quot;hover for duration&quot; node.</p>
<h2 id="selectors"><a class="header" href="#selectors"><code>Selectors</code></a></h2>
<p><em>aka <code>thinkers, parent nodes, composite nodes</code></em></p>
<p>Selectors are added to parent nodes and decide which children to run. </p>
<p>Here are some examples of selectors:</p>
<ul>
<li><code>SequenceSelector</code>
<ul>
<li>An action that runs all of its children in order until one fails.</li>
<li>Logical AND - <code>RUN child1 THEN child2 etc</code></li>
</ul>
</li>
<li><code>FallbackSelector</code>
<ul>
<li>An action that runs all of its children in order until one succeeds.</li>
<li>Logical OR: <code>RUN child1 OTHERWISE child2 etc</code></li>
</ul>
</li>
<li><code>UtilitySelector</code>
<ul>
<li>An action that observes the current <code>Score</code> of each child and selects the highest to run.</li>
</ul>
</li>
</ul>
<h2 id="common-components"><a class="header" href="#common-components">Common Components</a></h2>
<ul>
<li><code>Running</code>
<ul>
<li>Indicate this node is currently running.</li>
</ul>
</li>
<li><code>RunResult</code>
<ul>
<li>Notify their parent that this node has finished.</li>
</ul>
</li>
<li><code>Score</code>
<ul>
<li>Notify the parent how favourable it would be for this node to run.</li>
</ul>
</li>
<li><code>RunTimer</code>
<ul>
<li>How long the action has been running for.</li>
</ul>
</li>
</ul>
<h2 id="graph-terminology"><a class="header" href="#graph-terminology">Graph Terminology</a></h2>
<ul>
<li><code>BehaviorNode</code>
<ul>
<li>Literally a wrapper of a <code>Vec&lt;Action&gt;</code>. These can be either leaf or parent nodes.</li>
</ul>
</li>
<li><code>BehaviorGraph</code>
<ul>
<li>A <code>petgraph</code> collection of Nodes and directed links between them. </li>
<li>It <em>can</em> be cyclic but I prefer not to do that because it makes graphs more reusable and easier to reason about.</li>
</ul>
</li>
<li><code>Agent</code>
<ul>
<li>Any entity that has some components, ie ie <code>Transform</code> or <code>MotorSpeed</code>, to be read or modified by the behavior graph.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started-1"><a class="header" href="#getting-started-1">Getting Started</a></h1>
<!-- keep all code references in sync with docs please -->
<h2 id="worked-example"><a class="header" href="#worked-example">Worked Example</a></h2>
<pre class="mermaid">graph TB;
  A--&gt;B;
  A--&gt;C;
	C--&gt;D;
	C--&gt;E;

A[UtilitySelector]
B[
	ConstantScore: 0.5
	----------------
	Wander
]
C[
	TargetScorer: flower
	------------------------
	SequenceSelector
]
D[Seek]
E[SucceedInDuration: 1 second]
</pre>
<p>Lets go through each action in the diagram:</p>
<ol>
<li><code>UtilitySelector</code>: This will choose the child to run with the highest score.</li>
<li><code>ConstantScore</code>: Provides the parent with a constant score for this node.</li>
<li><code>Wander</code>: The bee will move around the map somewhat randomly.</li>
<li><code>TargetScorer</code>: This action has two roles:
<ul>
<li>Provide the parent with a score depending on whether a target named &quot;flower&quot; is nearby</li>
<li>Update <code>TargetEntity</code> component of its children.</li>
</ul>
</li>
<li><code>SequenceSelector</code>: Run each child in order until completion or one fails.</li>
<li><code>SucceedInDuration</code>: Upon arriving at the flower, wait for 1 second to emulate pollination.</li>
</ol>
<p>Notice how we are using these tiny actions to compose a behavior, every one of them is in the core library and we've created a behavior without writing any new code.</p>
<p>Furthermore this graph can very easily be attached as a <code>work mode</code> subgraph of a larger <code>bee</code> graph.</p>
<h2 id="agent-lifecycle"><a class="header" href="#agent-lifecycle">Agent Lifecycle</a></h2>
<ol>
<li>A graph is defined containing the relationships between nodes and the initial values for each of their accompanying actions.</li>
<li>When creating an agent, call <code>my_graph.spawn(my_agent)</code> which will do the following for each node in the graph:
<ul>
<li>Create an entity</li>
<li>If it has any children, put their entity ids in an <code>Edges</code> component</li>
<li>Create a component for each action</li>
</ul>
</li>
<li>When the agent is despawned, all entities in the graph are also despawned leaving no trace.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<ul>
<li>üê¶ Powered by <code>bevy_ecs</code> and <code>petgraph</code></li>
<li>üî• Highly Parallel</li>
<li>‚úçÔ∏è No Blackboard</li>
<li>üåà Multi-paradigm</li>
<li>üåç With or without Bevy Engine</li>
<li>üå¥ Create/edit graphs at runtime</li>
<li>üß© Multiple graphs per entity</li>
</ul>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This is my third attempt at a modular AI architecture for ECS, the previous two attempts went the way of the dodo:</p>
<ol>
<li>Shoehorn non-ecs solutions into bevy, which sucked mostly because of blackboards. </li>
<li>Get clever with generics and create distinct types <em>per node</em> of a graph. This allowed for an entire graph to be stored as components on a single entity but was not great for a bunch of reasons. The dealbreaker was not being able to create/edit graphs at runtime.</li>
</ol>
<p>I'm quite confident in this third approach, representing graphs as linked entities. </p>
<h3 id="actions-1"><a class="header" href="#actions-1">Actions</a></h3>
<p>Actions without children usually execute some behavior then return a <code>RunResult::Success</code> or a <code>RunResult::Failure</code>.</p>
<p>An <code>action</code> is a bevy component struct with an associated system. Currently all actions must implement <code>Default, Clone, Component, serde::Serialize, serde::Deserialize</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[action(system=print_action)]
#[derive(Default)]
pub struct PrintAction(pub value: String);

fn print_action(mut commands: Commands, query: Query&lt;(Entity,&amp;PrintAction), With&lt;Running&gt;){
	for (entity, action) in query.iter(){
		println!(&quot;Print Action: {}&quot;, action.0);
		commands.entity(entity).insert(RunResult::Success);
	}
}
<span class="boring">}</span></code></pre></pre>
<h3 id="shared-actions"><a class="header" href="#shared-actions">Shared Actions</a></h3>
<p>To solve the problem of, say every scoring system wanting a <code>Query&lt;&amp;mut Score&gt;</code> which would break parallelism, each action has a distinct component, and fields marked as <code>#[shared]</code> will be copied at the end of each tick when they change.</p>
<p>The below action will add a <code>Score</code> component to this entity and update it whenever the <code>ScoringAction</code> changes.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[action(system=scoring_action)]
pub struct ScoringAction{
	#[shared]
	pub score: Score
};
<span class="boring">}</span></code></pre></pre>
<p>Now we can have a utility selector that immutably queries the <code>Score</code> component of its children, allowing for full parallelism.</p>
<h3 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h3>
<p>Documentation is WIP, in the meantime have a look at <code>./crates/gamai/test/selectors</code> for examples of selectors and how they are used.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="beetmash"><a class="header" href="#beetmash">Beetmash</a></h1>
<p>üöß work in progress üöß</p>
<p>Beetmash a planned learning and creation platform for <code>beet</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><div class="table-wrapper"><table><thead><tr><th>Roadmap</th><th></th></tr></thead><tbody>
<tr><td>Behavior Trees</td><td>‚úÖ</td></tr>
<tr><td>State Trees</td><td>üöß</td></tr>
<tr><td>GOAP</td><td>üöß</td></tr>
<tr><td>Machine Learning</td><td></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="resources"><a class="header" href="#resources">Resources</a></h1>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<ul>
<li>
<p>GDC - <a href="https://youtu.be/IvK0ZlNoxjw">Modular AI</a></p>
</li>
<li>
<p>Chris Hecker - <a href="https://youtu.be/4eQp8SdzOa0">Structure Vs Style</a></p>
<ul>
<li><a href="https://chrishecker.com/Structure_vs_Style">blog</a></li>
</ul>
</li>
<li>
<p>Kevin Dill, Dave Mark - <a href="https://www.gdcvault.com/play/1012410/Improving-AI-Decision-Modeling-Through">Improving AI Decision Modeling Through Utility Theory</a></p>
</li>
<li>
<p>Kevin Dill, Dave Mark - <a href="https://www.gdcvault.com/play/1015683/Embracing-the-Dark-Art-of">Embracing the Dark Art of Mathematical Modeling in Game AI</a></p>
</li>
<li>
<p>Kevin Dill - <a href="https://www.sisostds.org/DesktopModules/Bring2mind/DMX/Download.aspx?Command=Core_Download&amp;EntryId=35466&amp;PortalId=0&amp;TabId=105">Introducing GAIA</a></p>
</li>
<li>
<p>Jakob Rasmussen - <a href="https://youtu.be/jse_ZleruJU">Utility AI - Apex Game Tooks - Unite 2016</a></p>
</li>
<li>
<p>Nicolas Meuleau - <a href="https://youtu.be/78nhJNPS0vA">Unity Labs - GOAP - 2017</a></p>
<ul>
<li>Follow-up - <a href="https://youtu.be/ZdN8dDa0ff4">2018</a></li>
</ul>
</li>
</ul>
<h2 id="ai-libraries"><a class="header" href="#ai-libraries">AI libraries</a></h2>
<ul>
<li>C++ Behavior trees - <a href="https://www.behaviortree.dev/">BehaviorTree.cpp</a></li>
<li>Bevy Utility AI - <a href="https://crates.io/crates/big-brain">big-brain</a></li>
</ul>
<h2 id="misc"><a class="header" href="#misc">Misc</a></h2>
<ul>
<li>YouTube - <a href="https://www.youtube.com/watch?v=KeShMInMjro&amp;list=PLFQdM4LOGDr_vYJuo8YTRcmv3FrwczdKg">Introduction to Behaviour Trees</a></li>
<li>YouTube - <a href="https://www.youtube.com/playlist?list=PLk-SPWGynZmM3jv0TCV-Shhe_ltgc7qxq">GDC Game AI Playlist</a></li>
</ul>
<h2 id="entity-relationships"><a class="header" href="#entity-relationships">Entity Relationships</a></h2>
<ul>
<li><a href="https://github.com/SanderMertens/flecs/blob/master/examples/cpp/game_mechanics/factory/src/main.cpp">Flecs - State Machine Example</a></li>
<li><a href="https://ajmmertens.medium.com/e7971da33ac3">Games as databases</a></li>
<li><a href="https://ajmmertens.medium.com/742de7a18e59">Why storing state machines in ecs is a bad idea</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<h2 id="crate-structure"><a class="header" href="#crate-structure">Crate structure</a></h2>
<pre class="mermaid">graph TB;
    beet_ecs--&gt;beet;
		beet_net--&gt;beet;
</pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="deps/custom.js"></script>
        <script src="deps/mermaid.min.js"></script>
        <script src="deps/mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
